#!/usr/bin/env zsh

fpath=(/usr/lib/zsh_libmisc/libmisc.zwc $fpath)
autoload libmiscinit
libmiscinit

input=$(fox-fr ./input)

isfile /tmp/dayeleven && \
  rm -rf /tmp/dayeleven

mkdir /tmp/dayeleven
mkdir /tmp/dayeleven_tmp

create_worker() {
#  print "worker "$worker_id": got "$input" for input"
  polish_stone() {
    [ "$stone" = 0 ] && \
      print -n '1 ' && \
      return 0
    stoneln=$(getstrln "$stone")
    isevennum "$stoneln" && {
      haploid=$((stoneln/2))
      stoneleft=$((${stone: :$haploid}))
      stoneright=$((${stone:$haploid}))
      print -n ""$stoneleft" "$stoneright" "
      return 0
    }
    print -n ""$(($stone*2024))" " && \
      return 0
  }

  blinks=0
  while true; do
    blinks=$((blinks+1))
    placeholder=""
    IFS=$' '
    for stone in $=input; do
      placeholder=""$placeholder""$(polish_stone)""
    done
    unset IFS
    input=$placeholder
#    print "Worker "$worker_id" blink count: "$blinks""
    [ "$blinks" = 5 ] && \
      break
  done
  print '' > /tmp/dayeleven_tmp/$worker_id
  print -n "$input" > /tmp/dayeleven/$worker_id
  return 0
}

print "pass 1/5"
## first pass (blinks=15)
worker_input_count=0
IFS=$' '
print "Starting workers..."
for distrib_input in $=input; do
  worker_input_count=$((worker_input_count+1))
#  print "pre-worker input "$distrib_input""
  worker_id=$worker_input_count input="$distrib_input" create_worker &
done
unset IFS
print "finished start workers"
#wait_for_pass
wait

## => 2nd pass
mo_passes() {
  print "combining worker outputs into next input"
  unset input
  input=$(cat /tmp/dayeleven/*)
  rm -rf /tmp/dayeleven
  mkdir /tmp/dayeleven
  worker_input_count=0
  IFS=$' '
  print "starting workers..."
  for distrib_input in $=input; do
    worker_input_count=$((worker_input_count+1))
    print -n "pre-worker input "$distrib_input""
    worker_id="$worker_input_count" input="$distrib_input" create_worker &
  done
  unset IFS
  print "finished start workers"
}

do_until_passes=4
#set current pass to 1 since we already did one earlier
current_pass=1
while true; do
  print "pass "$((current_pass+1))"/5"
  mo_passes
  wait
  current_pass=$((current_pass+1))
  [ "$current_pass" -gt "$do_until_passes" ] && \
    break
done

print "counting final results"
final_total=0
final_input=$(cat /tmp/dayeleven/*)
IFS=$' '
for thefinal_countdown in $=final_input; do
  final_total=$((thefinal_countdown+final_total))
done
unset IFS

print "$final_total"
